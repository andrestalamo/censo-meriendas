---
title: "Censo de Meriendas"
logo: img/mate.png
format: dashboard

theme: 
  - minty
  
  
execute: 
  echo: false
  warning: false
---

```{r}
#| label: paquetes

library(tidyverse)
library(janitor)
library(tidytext)
library(wordcloud2)
library(stopwords)
library(googlesheets4)
library(scales)
library(htmltools)

# Desactiva OAuth para leer hojas p√∫blicas (permiso ‚Äúcualquiera con el enlace‚Äù).
# Usalo solo si la hoja es realmente p√∫blica; si no, dar√° un error.
googlesheets4::gs4_deauth() 

```


```{r}
#| label: datos

raw <- read_sheet("1M4BfvfClvKog7rmbxh6UzzOAf84jPz87Tl-UHM5hvBA")

df <- raw |>
  janitor::clean_names() |>
  rename(
    marca_temporal = marca_temporal,
    pais           = desde_que_pais_te_estas_conectando,
    bebida         = con_que_bebida_te_gusta_merendar_normalmente,
    comida         = que_te_gusta_comer_normalmente,
    horario    = en_que_horario_aproximadamente_merendas,
    lugar          = donde_soles_merendar,
    imprescindible = que_es_lo_que_nunca_puede_faltar_en_tu_merienda_ideal) |>
  mutate(marca_temporal = ymd_hms(marca_temporal)) |>
  mutate(horario = hour(horario))

n_resp   <- nrow(df)
n_paises <- n_distinct(df$pais, na.rm = TRUE)
top_bebida <-   df |> 
  count(bebida, sort = TRUE) |>
  slice_head(n = 1) |> 
  pull(bebida) 

ultima_respuesta     <- max(df$marca_temporal, na.rm = TRUE)
ultima_actualizacion <- Sys.time()-hours(3)


url_formulario <- "https://forms.gle/4AGu9StQKVsVvj5x7"


```

## Fila 0. Texto introductorio {height="25%"}

::: {.card width="70%"}

Este tablero forma parte del tutorial **‚ÄúAutomatiza la publicaci√≥n de tus reportes con Quarto y GitHub Actions‚Äù**, dictado en el marco de **LatinR 2025**. Su finalidad es exclusivamente ilustrativa: muestra un flujo de trabajo reproducible que conecta un formulario en l√≠nea con un dashboard generado autom√°ticamente a partir de las respuestas recibidas. Fue actualizado por √∫ltima vez el **`r format(ultima_actualizacion, '%d/%m/%Y %H:%M')`**. Est√° asociado a este üëâ[formulario](`r url_formulario`).  

:::

```{r}
#| content: valuebox
#| title: "Respuestas"
#| icon: chat-dots
#| color: "#93D8B9"
#| width: 30%
#| fill: false

htmltools::HTML(
  paste0(
    '<div style="text-align:left; line-height:1.1; margin-top:-0.4rem; overflow:hidden;">',

      '<div style="font-size: 2rem; font-weight:600; margin:0.1rem 0;">',
        n_resp,
      '</div>',
      

      '<div style="font-size:0.85rem; margin-top:0.2rem;">',
        '√öltima: ', format(ultima_respuesta, "%d/%m/%Y %H:%M"),
      '</div>',
      
    '</div>'
  )
)

```

## Fila 1. Pa√≠s, hora y d√≥nde

```{r}
#| label: pais-de-participantes
#| title: "Participaci√≥n por pa√≠s"

df %>%
  filter(!is.na(pais), pais != "") %>%
  count(pais) %>%
  mutate(perc = n / sum(n)) %>%
  ggplot(aes(x = fct_reorder(pais, perc), y = perc, fill = pais)) +
  geom_col() +
  geom_text(aes(label = percent(perc, accuracy = 0.1)),
            hjust = -0.1, size = 8) +
  coord_flip(clip = "off") +
  scale_y_continuous(labels = percent_format(),
                     expand = expansion(mult = c(0, 0.2))) +
  paletteer::scale_fill_paletteer_d("palettesForR::Pastels") +
  labs(x = NULL, y = NULL) +
  theme_minimal() +
  theme(legend.position = "none",
         text = element_text(size = 22))
  

```


```{r}
#| label: horario-de-merienda
#| title: "Horario de merienda"

df %>%
  filter(!is.na(horario), horario != "") %>%
  ggplot(aes(x = horario)) +
  geom_histogram(fill = "#0072B2") +
  scale_y_continuous(labels = percent_format(),
                     expand = expansion(mult = c(0, 0.2))) +
 labs(x = NULL, y = NULL) +
  theme_minimal() +
  theme(legend.position = "none",
         text = element_text(size = 22))
  

```


```{r}
#| label: lugar-de-merienda
#| title: "¬øD√≥nde se merienda?"
#| fig-width: 12
#| fig-height: 5

df %>%
  filter(!is.na(lugar), lugar != "") %>%
  count(lugar, name = "n") %>%
  arrange(desc(n)) %>%                     
  mutate(
    perc = n / sum(n),
    lbl  = percent(perc, accuracy = 0.1),
    ymax = cumsum(perc),
    ymin = ymax - perc,
    ymid = (ymin + ymax) / 2
  ) %>%
  ggplot(aes(
    ymin = ymin,
    ymax = ymax,
    xmin = 1,
    xmax = 2,
    fill = fct_reorder(lugar, perc)
  )) +
  geom_rect(width = 3, color = "white") +
  geom_text(
    aes(
      x = 1.5,
      y = ymid,         
      label = lbl
    ),
    color = "white",
    size = 8
  ) +
  coord_polar(theta = "y") +
  xlim(0.5, 2.5) +
  paletteer::scale_fill_paletteer_d("palettesForR::Pastels") +
  labs(fill = "") +
  theme_void() +
  theme(
    legend.position = "right",
    plot.margin = margin(0, 0, 0, 0),
    text = element_text(size = 22),      
    legend.text = element_text(size = 22))


```

## Fila 2. Bebida, comida y qu√© no puede faltar

```{r}
#| label: bebida
#| title: "Bebidas m√°s elegidas"
 
df %>%
  filter(!is.na(bebida), bebida != "") %>%
  count(bebida) %>%
  mutate(perc = n / sum(n)) %>%
  ggplot(aes(x = fct_reorder(bebida, perc), y = perc, fill = bebida)) +
  geom_col() +
  geom_text(aes(label = percent(perc, accuracy = 0.1)),
            hjust = -0.1, size = 8) +
  coord_flip(clip = "off") +
  scale_y_continuous(labels = percent_format(),
                     expand = expansion(mult = c(0, 0.2))) +
  paletteer::scale_fill_paletteer_d("palettesForR::Pastels") +
  labs(x = NULL, y = NULL) +
  theme_minimal() +
  theme(legend.position = "none",
         text = element_text(size = 22))

```


```{r}
#| label: comida
#| title: "Tipo de comida"
#| fig-width: 12
#| fig-height: 5


df %>%
  filter(!is.na(comida), comida != "") %>%
  count(comida, name = "n") %>%
  arrange(desc(n)) %>%                     
  mutate(
    perc = n / sum(n),
    lbl  = percent(perc, accuracy = 0.1),
    ymax = cumsum(perc),                   
    ymin = ymax - perc,                    
    ymid = (ymin + ymax) / 2                 
  ) %>%
  ggplot(aes(
    ymin = ymin,
    ymax = ymax,
    xmin = 1,
    xmax = 2,
    fill = comida
  )) +
  geom_rect(width = 3, color = "white") +
  geom_text(
    aes(
      x = 1.5,          
      y = ymid,         
      label = lbl
    ),
    color = "white",
    size = 8
  ) +
  coord_polar(theta = "y") +
  paletteer::scale_fill_paletteer_d("palettesForR::Pastels") +
  xlim(0.5, 2.5) +
  labs(fill = "") +
  theme_void() +
  theme(    
    legend.position = "right",
    plot.margin = margin(0, 0, 0, 0),
    text = element_text(size = 22),      
    legend.text = element_text(size = 22))



```

```{r}
#| label: que-no-puede-faltar
#| title: "Qu√© no puede faltar"


# preparar texto
freq <- df |>
  select(imprescindible) |>
  mutate(imprescindible = tolower(imprescindible)) |>
  unnest_tokens(word, imprescindible) |>
  filter(!word %in% stopwords("es")) |>
  filter(!is.na(word)) |>
  count(word, sort = TRUE)

wordcloud2(freq, size = 0.3, shape = "circle", rotateRatio = 0)


```

